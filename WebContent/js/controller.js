function controller(aa,ba){this.canvas=$id(aa);this.ctx=this.canvas.getContext('2d');this.region=ba.region;this.bar=ba.bar;this.value=ba.value;this.minBarDistance=ba.minBarDistance||5;this.onPositionChanged=ba.onPositionChanged;this.prePaint=ba.prePaint;this.isTouchDevice=isTouchDevice();this.touchFaultTolerance=ba.touchFaultTolerance;}
controller.prototype={calcPositions:function(){var ca=(this.region.width-this.bar.width);this.leftBarPosition=this.value.left*ca / 100 + this.bar.width / 2;this.rightBarPosition=this.value.right*ca / 100 + this.bar.width / 2;},drawControllerPart:function(){var da=this.canvas;var ea=this.ctx;ea.save();var fa=this.region;var ga=this.bar;this.calcPositions();var ha=this.leftBarPosition;var ia=this.rightBarPosition;ea.clearRect(fa.x-1,fa.y-1,fa.width+1,fa.height+1);if(typeof this.prePaint=='function'){this.prePaint(ea);}
ea.lineWidth=1;ea.strokeStyle=ga.borderColor;ea.beginPath();ea.moveTo(fa.x+ha-ga.width/2+0.5,fa.y+0.5);ea.lineTo(fa.x+0.5,fa.y+0.5);ea.lineTo(fa.x+0.5,fa.y+fa.height-0.5);ea.lineTo(fa.x+ha-ga.width/2+0.5,fa.y+fa.height-0.5);ea.stroke();ea.beginPath();ea.moveTo(fa.x+ia+ga.width/2-0.5,fa.y+fa.height-0.5);ea.lineTo(fa.x+fa.width-0.5,fa.y+fa.height-0.5);ea.lineTo(fa.x+fa.width-0.5,fa.y+0.5);ea.lineTo(fa.x+ia+ga.width/2-0.5,fa.y+0.5);ea.stroke();ea.strokeStyle=ga.contrBorder;ea.beginPath();ea.moveTo(Math.floor(fa.x+ha-ga.width / 2) + 0.5, region.y + region.height / 2-ga.height/2);ea.lineTo(Math.floor(fa.x+ha-ga.width/2)+0.5,fa.y+0.5);ea.lineTo(Math.floor(fa.x+ia+ga.width/2)-0.5,fa.y+0.5);ea.lineTo(Math.floor(fa.x+ia+ga.width / 2) - 0.5, region.y + region.height / 2-ga.height/2);ea.stroke();ea.beginPath();ea.moveTo(Math.floor(fa.x+ha-ga.width / 2) + 0.5, region.y + region.height - (region.height - bar.height) / 2-0.5);ea.lineTo(Math.floor(fa.x+ha-ga.width/2)+0.5,fa.y+fa.height-0.5);ea.lineTo(Math.floor(fa.x+ia+ga.width/2)-0.5,fa.y+fa.height-0.5);ea.lineTo(Math.floor(fa.x+ia+ga.width / 2) - 0.5, region.y + region.height / 2+ga.height/2);ea.stroke();ea.beginPath();ea.fillStyle=ga.contrFill;ea.globalAlpha=.2;ea.rect(Math.floor(fa.x+ha-ga.width / 2) + 0.5, region.y + 0.5, Math.floor(region.x + rightBarPosition + bar.width / 2)-Math.floor(fa.x+ha-ga.width/2),fa.height-1);ea.closePath();ea.fill();ea.globalAlpha=.6;ea.fillStyle=ga.fillColor;ea.beginPath();var ja={x:Math.floor(fa.x+ha-ga.width / 2) + 0.5, y: region.y + region.height / 2-ga.height/2,width:ga.width,height:ga.height};ea.rect(ja.x,ja.y,ja.width,ja.height);this.leftBarRegion=ja;ea.closePath();ea.stroke();ea.fill();ea.beginPath();var ka={x:Math.floor(fa.x+ia-ga.width / 2) + 0.5, y: region.y + region.height / 2-ga.height/2,width:ga.width,height:ga.height};ea.rect(ka.x,ka.y,ka.width,ka.height);this.rightBarRegion=ka;ea.closePath();ea.stroke();ea.fill();ea.restore();ea.strokeStyle=ga.contrBorder;ea.beginPath();ea.moveTo(fa.x+ha-ga.width / 6, region.y + region.height / 3);ea.lineTo(fa.x+ha-ga.width / 6, region.y + region.height / 3*2);ea.stroke();ea.beginPath();ea.moveTo(fa.x+ha+ga.width / 6, region.y + region.height / 3);ea.lineTo(fa.x+ha+ga.width / 6, region.y + region.height / 3*2);ea.stroke();ea.beginPath();ea.moveTo(fa.x+ia-ga.width / 6, region.y + region.height / 3);ea.lineTo(fa.x+ia-ga.width / 6, region.y + region.height / 3*2);ea.stroke();ea.beginPath();ea.moveTo(fa.x+ia+ga.width / 6, region.y + region.height / 3);ea.lineTo(fa.x+ia+ga.width / 6, region.y + region.height / 3*2);ea.stroke();},setLeftBarPosition:function(x){if(x<this.bar.width / 2) this.leftBarPosition = this.bar.width / 2;else if(this.rightBarPosition-x-this.minBarDistance>this.bar.width)this.leftBarPosition=x;else this.leftBarPosition=this.rightBarPosition-this.bar.width-this.minBarDistance;this.value=this.getValue();},setRightBarPosition:function(x){if(x<this.leftBarPosition+this.bar.width+this.minBarDistance)this.rightBarPosition=this.leftBarPosition+this.bar.width+this.minBarDistance;else if(x>this.region.width-this.bar.width / 2) this.rightBarPosition = this.region.width - this.bar.width / 2;else this.rightBarPosition=x;this.value=this.getValue();},addControllerEvents:function(){var me=this;if(me.isTouchDevice){var la=me.canvas;addEvent(la,'touchmove',function(e){e=e||event;var ma=e.srcElement||e.target||e.relatedTarget;var na=e.touches;if(!na||!na.length)return;var oa=false;var pa=getPageCoord(this.canvas);if(me.fingers&&me.fingers.length){for(var i=0;i<me.fingers.length;i++){var qa=me.fingers[i];for(var j=0;j<na.length;j++){var ra=na[j];if(ra.identifier==qa.id){var sa=ra.pageX-pa.x;var ta=(sa-qa.startX);if(ta!=0){if(qa.type=='left'){me.setLeftBarPosition(qa.leftPosition+ta);}
else if(qa.type=='right'){me.setRightBarPosition(qa.rightPosition+ta);}
else{me.setLeftBarPosition(qa.leftPosition+ta);me.setRightBarPosition(qa.rightPosition+ta);}
oa=true;}
break;}}}}
if(oa){me.drawControllerPart();if(typeof me.onPositionChanged=='function'&&me.isValueChanged()){me.value=me.getValue();me.onPositionChanged(me.value);}}
disableBubbleAndPreventDefault(e);});addEvent(la,'touchend',function(e){e=e||event;if(me.fingers&&me.fingers.length){if(typeof me.onPositionChanged=='function'&&me.isValueChanged()){me.value=me.getValue();me.onPositionChanged(me.value);}}
else{var ua=new Date().getTime()-me.touchstartTime.getTime();if(ua<window.tapTimeLimit&&me.startTouch){var va=getPageCoord(me.canvas);var wa=me.startTouch;var xa={offsetX:wa.pageX-va.x,offsetY:wa.pageY-va.y};var ya=(me.rightBarPosition+me.leftBarPosition)/2;var za=xa.offsetX-ya;me.setLeftBarPosition(me.leftBarPosition+za);me.setRightBarPosition(me.rightBarPosition+za);me.drawControllerPart();if(typeof me.onPositionChanged=='function'&&me.isValueChanged()){me.value=me.getValue();me.onPositionChanged(me.value);}
me.startTouch=null;}}
me.fingers=null;disableBubbleAndPreventDefault(e);});addEvent(la,'touchstart',function(e){var Aa=e.touches;if(!Aa||!Aa.length)Aa=e.changedTouches;me.touchstartTime=new Date();me.startTouch=Aa[0];var Ba=e.srcElement||e.target||e.relatedTarget;var Ca=getPageCoord(me.canvas);function getTouchType(Da){if(me.isOnLeftBar(Da))return 'left';if(me.isOnRightBar(Da))return 'right';if(me._isBetweenLeftAndRight(Da))return 'middle';return false;}
me.fingers=[];if(Aa.length){for(var i=0;i<Aa.length;i++){var Ea=Aa[i];var Fa={offsetX:Ea.pageX-Ca.x,offsetY:Ea.pageY-Ca.y};var Ga=getTouchType(Fa);if(!Ga)continue;var Ha={id:Ea.identifier,startX:Ea.pageX-Ca.x,type:Ga,leftPosition:me.leftBarPosition,rightPosition:me.rightBarPosition};me.fingers.push(Ha);}}
disableBubbleAndPreventDefault(e);return false;});}
else{var Ia=function(ev){var Ja=me.isOnLeftBar(ev);var Ka=me.isOnRightBar(ev);if(me._isBetweenLeftAndRight(ev)){document.body.style.cursor='pointer';}
else if(Ja||Ka||me.triggerBar){document.body.style.cursor='col-resize';}
else{document.body.style.cursor='default';}
if(me.triggerBar){me.triggerBar.targetX=ev.offsetX;var La=(me.triggerBar.targetX-me.triggerBar.x);if(me.triggerBar.type=='left'){document.body.style.cursor='col-resize';me.setLeftBarPosition(me.triggerBar.position+La);}
else if(me.triggerBar.type=='right'){me.setRightBarPosition(me.triggerBar.position+La);}
else{me.setLeftBarPosition(me.triggerBar.leftPosition+La);me.setRightBarPosition(me.triggerBar.rightPosition+La);}
if(typeof me.onPositionChanged=='function'&&me.isValueChanged()){me.value=me.getValue();me.onPositionChanged(me.value);}
me.drawControllerPart();}};var Ma=function(ev){if(me.triggerBar){}
me.triggerBar=null;document.body.style.cursor='default';if(typeof me.onPositionChanged=='function'&&me.isValueChanged()){me.value=me.getValue();me.onPositionChanged(me.value);}};var Na=function(ev){var Oa=me.isOnLeftBar(ev);var Pa=me.isOnRightBar(ev);var Qa=me._isBetweenLeftAndRight(ev);if(Qa){document.body.style.cursor='pointer';}
else if(Oa||Pa){document.body.style.cursor='col-resize';}
else{document.body.style.cursor='default';}
if(Oa)me.triggerBar={type:'left',x:ev.offsetX,position:me.leftBarPosition};else if(Pa)me.triggerBar={type:'right',x:ev.offsetX,position:me.rightBarPosition};else if(Qa)me.triggerBar={type:'middle',x:ev.offsetX,leftPosition:me.leftBarPosition,rightPosition:me.rightBarPosition};else me.triggerBar=null;};addEvent(me.canvas,'mouseup',Ma);addEvent(me.canvas,'mouseout',Ma);addEvent(me.canvas,'mousemove',function(ev){ev=ev||event;if(ev.preventDefault)ev.preventDefault();else ev.returnValue=false;var Ra=getOffset(ev);Ia(Ra);});addEvent(me.canvas,'mousedown',function(ev){ev=ev||event;var Sa=getOffset(ev);Na(Sa);});}},isValueChanged:function(){if(typeof this.preValue=='undefined'){this.preValue=this.getValue();return false;}
if(isTouchDevice()&&this.latestChangeTime){var Ta=new Date();if(Ta.getTime()-this.latestChangeTime.getTime()<50)return false;}
var Ua=this.preValue;var Va=this.getValue();var Wa=Math.abs(Va.left-Ua.left)+Math.abs(Va.right-Ua.right);this.preValue=Va;var Xa=Wa!=0;if(Xa){this.latestChangeTime=new Date();}
return Wa!=0;},_isInRegion:function(ev,Ya){return ev.offsetX>Ya.x&&ev.offsetX<Ya.x+Ya.width&&ev.offsetY>Ya.y&&ev.offsetY<Ya.y+Ya.height;},_isBetweenLeftAndRight:function(ev){var Za=this.region;var $a={x:Za.x+this.leftBarPosition+this.bar.width/2,y:Za.y,width:this.rightBarPosition-this.leftBarPosition-this.bar.width,height:this.region.height};return this._isInRegion(ev,$a);},_getTouchFaultToleranceRegion:function(ab){var me=this;if(me.isTouchDevice){ab.x-=me.touchFaultTolerance/2;ab.width+=me.touchFaultTolerance/2;}
return ab;},isOnLeftBar:function(ev){var bb=this._getTouchFaultToleranceRegion(this.leftBarRegion);return this._isInRegion(ev,bb);},isOnRightBar:function(ev){var cb=this._getTouchFaultToleranceRegion(this.rightBarRegion);return this._isInRegion(ev,cb);},getValue:function(){var db=this.region.width-this.bar.width;return{left:(this.leftBarPosition-this.bar.width / 2) * 100 / db,right:(this.rightBarPosition-this.bar.width / 2) * 100 / db};}};